(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[304],{1337:(e,t,n)=>{Promise.resolve().then(n.bind(n,8256))},3020:(e,t,n)=>{"use strict";async function r(e,t,n,r){let i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"POST",o=async n=>fetch(e,{method:i,headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(n)},body:JSON.stringify(t)}),a=await o(n);if((401===a.status||403===a.status)&&r)try{let e=await r();e&&(a=await o(e))}catch(e){}if(!a.ok){let t=Error("HTTP ".concat(a.status));t.status=a.status,t.url=e;try{t.body=await a.text()}catch(e){}throw t}return a}async function i(e,t,n){let i=await r("https://6ts7sjoaw6.execute-api.ap-southeast-2.amazonaws.com/test/getIMEI",{email:e},t,n),o=await i.json(),a={};try{var l;a=JSON.parse(null!=(l=null==o?void 0:o.body)?l:"{}")}catch(e){console.error("getIMEIList JSON parse error",e)}let s=Array.isArray(null==a?void 0:a.items)?a.items:[],u=Array.isArray(null==a?void 0:a.dev_access)?a.dev_access:[];return{items:s.filter(e=>Array.isArray(e.Coordinate)&&2===e.Coordinate.length),dev_access:u.map(e=>Array.isArray(e)?e.map(String):[])}}async function o(e,t,n){var i;let o=await r("https://6ts7sjoaw6.execute-api.ap-southeast-2.amazonaws.com/test/getLatestDP",{IMEI:e},t,n),a=JSON.parse(null!=(i=(await o.json()).body)?i:"[]"),l={},s={},u=0;for(let e of a)s[u]=e.DeviceType,l[e.DeviceType]=e,u++;return{deviceMap:l,deviceTypes:s}}async function a(e,t,n,i,o,a){var l;let s=await r("https://6ts7sjoaw6.execute-api.ap-southeast-2.amazonaws.com/test/getDpFromTime",{IMEI:e,startDateTime:t,endDateTime:n,timeInterval:o},i,a),u=JSON.parse(null!=(l=(await s.json()).body)?l:"{}");return{deviceTypes:u.deviceTypes||[],items:u.items||[]}}function l(e){let{IMEI:t,idToken:n,getIdToken:r,intervalMs:i=3e5,callback:a}=e,l=null,s=n;async function u(){try{let e;try{e=await o(t,s)}catch(n){if(((null==n?void 0:n.status)===401||(null==n?void 0:n.status)===403)&&r)try{let i=await r();if(i)s=i,e=await o(t,s);else throw n}catch(e){throw null!=e?e:n}else throw n}a(e)}catch(e){console.error("Poller tick failed:",e)}}return{async start(){await u(),l&&window.clearInterval(l),l=window.setInterval(u,i)},stop(){l&&(window.clearInterval(l),l=null)}}}n.d(t,{A5:()=>o,I:()=>a,W4:()=>l,bC:()=>i})},5310:(e,t,n)=>{"use strict";n.d(t,{S:()=>s});var r=n(5155),i=n(2115),o=n(877),a=n(1607);function l(e){let{title:t,value:n,max:a=100,unit:l="",color:s="#26b6b2",compact:u=!1}=e,c=Math.max(0,Math.min(Number(n),Number(a))),d=Math.max(0,Number(a)-c),m=u?16:20,p=(0,i.useRef)(null);return(0,i.useEffect)(()=>{let e=()=>{var e,t,n;let r=null==(t=p.current)||null==(e=t.querySelector("canvas"))?void 0:e.parentElement;null==r||null==(n=r.forceUpdate)||n.call(r)};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[u]),(0,r.jsxs)("div",{className:"panel",style:{padding:u?10:12},children:[(0,r.jsx)("div",{style:{fontWeight:800,marginBottom:8,textAlign:"center",fontSize:u?18:22},children:t}),(0,r.jsxs)("div",{ref:p,style:{height:u?120:150,position:"relative",display:"flex",alignItems:"center",justifyContent:"center"},children:[(0,r.jsx)(o.nu,{data:{labels:["Value","Remaining"],datasets:[{label:t,data:[c,d],backgroundColor:[s,"#d7d9dd"],hoverOffset:4,borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,rotation:-125,circumference:80*Math.PI,cutout:"60%",plugins:{legend:{display:!1},tooltip:{enabled:!1},title:{display:!1}},layout:{padding:0}},style:{width:"100%",height:"100%"}}),(0,r.jsx)("div",{style:{position:"absolute",textAlign:"center",pointerEvents:"none",top:"50%",left:"50%",transform:"translate(-50%, -50%)",lineHeight:1},children:(0,r.jsxs)("div",{style:{fontSize:"".concat(m,"px"),fontWeight:800,color:"#111",marginTop:30,display:"block"},children:[(0,r.jsx)("span",{style:{fontSize:"22px",fontWeight:"bold"},children:String(c)}),l&&(0,r.jsxs)("span",{style:{fontSize:"14px"},children:[" ",l]})]})})]})]})}function s(e){let{deviceMap:t,device:n,dataType:i,compact:o=!1}=e;if(!t||!n||0===n.length)return(0,r.jsx)("pre",{children:"No latest data yet"});let a=[];return(n.forEach(e=>{var n,r;let o=t[e];if(!o)return;let l=null==(r=o.Timestamp)||null==(n=r.split(".")[0])?void 0:n.replace("T"," "),s=Object.keys(o).filter(e=>!["Timestamp","DeviceID","DeviceType"].includes(e)&&"number"==typeof o[e]);(i&&i.length>0?s.filter(e=>i.includes(e)):s).forEach(t=>{let{max:n,unit:r,color:i}=function(e,t){let n={DSI:{max:31,unit:"Days",color:"#f2a007"},DSO:{max:31,unit:"Days",color:"#ff4d57"},DPO:{max:31,unit:"Days",color:"#11a36f"},CurrentRatio:{max:5,unit:"%",color:"#2b6ea6"},Humidity:{max:100,unit:"%",color:"#26b6b2"},Temperature:{max:50,unit:"\xb0C",color:"#ff9f40"},CO2:{max:2e3,unit:"ppm",color:"#9966ff"},PM2_5:{max:200,unit:"\xb5g/m\xb3",color:"#4bc0c0"},PM10:{max:200,unit:"\xb5g/m\xb3",color:"#36a2eb"},Battery:{max:100,unit:"%",color:"#2ecc71"}}[e];return n||(t<=1?{max:1,unit:"",color:"#26b6b2"}:t<=10?{max:10,unit:"",color:"#26b6b2"}:t<=100?{max:100,unit:"",color:"#26b6b2"}:t<=1e3?{max:1e3,unit:"",color:"#26b6b2"}:{max:Math.ceil(1.2*t),unit:"",color:"#26b6b2"})}(t,Number(o[t]));a.push({title:"".concat(e," • ").concat(t),value:Number(o[t]),max:n,unit:r,color:i,ts:l})})}),0===a.length)?(0,r.jsx)("pre",{children:"No numeric fields to display"}):(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{style:{marginBottom:8,opacity:.7},children:["Latest timestamp: ",a[0].ts||"-"]}),(0,r.jsx)("div",{className:"dashboard-grid",style:{gridTemplateColumns:"repeat(auto-fit, minmax(".concat(o?160:220,"px, 1fr))"),gap:o?12:16},children:a.map((e,t)=>(0,r.jsx)(l,{...e,compact:o},t))})]})}a.t1.register(a.Bs,a.m_,a.s$)},8256:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>F});var r=n(5155),i=n(2115),o=n(6879),a=n(258),l=n(3646),s=n(3060),u=n(6750),c=n(3531),d=n(5339),m=n(5680),p=n(5469),f=n(848),h=n(4689),g=n(5310),v=n(1607),x=n(877);function y(e){let{deviceMap:t,deviceType:n,dataType:o,maxPoints:a=10,title:l="Realtime Line Chart",height:s=180,historyRef:u}=e,c=(0,i.useMemo)(()=>{if(t&&n)return t[n]},[t,n]),d=(0,i.useMemo)(()=>{if(!c)return[];let e=new Set(["Timestamp","DeviceID","DeviceType"]),t=Object.keys(c).filter(t=>!e.has(t)&&"number"==typeof c[t]);return o&&o.length>0?t.filter(e=>o.includes(e)):t},[c,o]),[m,p]=(0,i.useState)([]),[f,h]=(0,i.useState)({});(0,i.useMemo)(()=>JSON.stringify([...null!=o?o:[]].sort()),[o]),(0,i.useEffect)(()=>{if(!n)return;let e=null==u?void 0:u.current,t=null==e?void 0:e[n];t&&(p([...t.timestamps]),h({...t.seriesMap}))},[n,u]),(0,i.useEffect)(()=>{if(!c||0===d.length||!n)return;let e=c.Timestamp,t="string"==typeof e?e:String(null!=e?e:"");t.includes("T")&&(t=t.split(".")[0].replace("T"," "));let r=null==u?void 0:u.current,i=(null==r?void 0:r[n])||{timestamps:[],seriesMap:{}},o=[...i.timestamps,t],l=o.length>a?o.slice(o.length-a):o,s={...i.seriesMap};d.forEach(e=>{let t=c[e];if("number"!=typeof t||!Number.isFinite(t))return;let n=s[e]?[...s[e]]:[];n.push(Number(t)),s[e]=n.length>a?n.slice(n.length-a):n}),r&&(r[n]={timestamps:l,seriesMap:s}),p(l),h(s)},[c,d,a,n,u]),(0,i.useEffect)(()=>{let e=null==u?void 0:u.current;e&&(Object.keys(e).forEach(t=>{let n=e[t];n&&(n.timestamps.length>a&&(n.timestamps=n.timestamps.slice(n.timestamps.length-a)),Object.keys(n.seriesMap).forEach(e=>{let t=n.seriesMap[e]||[];t.length>a&&(n.seriesMap[e]=t.slice(t.length-a))}))}),p(e=>e.length>a?e.slice(e.length-a):e),h(e=>{let t={};return Object.keys(e).forEach(n=>{let r=e[n]||[];t[n]=r.length>a?r.slice(r.length-a):r}),t}))},[a,u]);let g=["#36a2eb","#ff6384","#4bc0c0","#9966ff","#ff9f40","#2ecc71","#e74c3c","#3498db","#9b59b6","#16a085"];return n?c?0===d.length?(0,r.jsxs)("div",{className:"panel",children:[(0,r.jsx)("div",{className:"section-title",children:l}),(0,r.jsxs)("div",{children:["No numeric fields to chart for ",n,"."]})]}):(0,r.jsxs)("div",{className:"panel",style:{marginTop:16},children:[(0,r.jsx)("div",{className:"section-title",style:{fontSize:20,fontWeight:800},children:l}),d.map((e,t)=>{let i={labels:m,datasets:[{label:n?"".concat(n," • ").concat(e):e,data:f[e]||[],borderColor:g[t%g.length],backgroundColor:"transparent",tension:.15}]},o={responsive:!0,maintainAspectRatio:!1,interaction:{mode:"nearest",intersect:!1},plugins:{legend:{display:!1},title:{display:!0,text:n?"".concat(n," • ").concat(e):e,font:{size:16,weight:"bold"}},tooltip:{enabled:!0,displayColors:!1,callbacks:{title:()=>"",label:e=>{var t;return String("number"==typeof(null==(t=e.parsed)?void 0:t.y)?e.parsed.y:e.raw)}}}},scales:{x:{display:!0,title:{display:!1},ticks:{display:!1}},y:{display:!0}}};return(0,r.jsx)("div",{style:{height:s,marginBottom:10},children:(0,r.jsx)(x.N1,{data:i,options:o})},e)}),(0,r.jsxs)("div",{style:{marginTop:6,opacity:.7,fontSize:12},children:["Max ",a," points; older points are dropped."]})]}):(0,r.jsxs)("div",{className:"panel",children:[(0,r.jsx)("div",{className:"section-title",children:l}),(0,r.jsxs)("div",{children:["No latest data found for ",n,"."]})]}):(0,r.jsxs)("div",{className:"panel",children:[(0,r.jsx)("div",{className:"section-title",children:l}),(0,r.jsx)("div",{children:"Select a device to start polling."})]})}v.t1.register(v.PP,v.kc,v.FN,v.No,v.hE,v.m_,v.s$);var b=n(3020),j=n(8680),w=n(9871);let S=m.Ay().scale(400).translate([0,0]);function M(e){let t=new d.ypk;return e.forEach((e,n)=>{let[r,i]=e,[o,a]=S([r,i]);0===n?t.moveTo(o,-a):t.lineTo(o,-a)}),t}function C(e){var t,n;let{feature:o,onClick:a,isSelected:s,onSelectName:u,hoverScaleZ:c=3}=e,m=(0,i.useMemo)(()=>(function(e){let t=[];return"Polygon"===e.geometry.type?t.push(M(e.geometry.coordinates[0])):"MultiPolygon"===e.geometry.type&&e.geometry.coordinates.forEach(e=>{t.push(M(e[0]))}),t})(o),[o]),p=(0,i.useMemo)(()=>m.map(e=>new d.QCA(e,{depth:5,bevelEnabled:!1})),[m]),f=(0,i.useMemo)(()=>m.map(e=>{let t=e.getPoints(256).map(e=>new d.Pq0(e.x,e.y,5.05));t.length>0&&t.push(t[0].clone());let n=new d.LoY;return n.setFromPoints(t),n}),[m]),h=(0,i.useMemo)(()=>{let e=new d.Pq0(0,0,6),t=-1/0;return p.forEach(n=>{n.computeBoundingBox();let r=n.boundingBox;if(!r)return;let i=(r.max.x-r.min.x)*(r.max.y-r.min.y),o=new d.Pq0;r.getCenter(o),i>t&&(t=i,e=new d.Pq0(o.x,o.y,6))}),e},[p]),[g,v]=(0,i.useState)(!1);return(0,r.jsxs)("group",{children:[p.map((e,t)=>(0,r.jsx)("mesh",{geometry:e,scale:[1,1,g?c:1],onClick:()=>{var e,t;null==a||a(o),null==u||u(null!=(t=null==(e=o.properties)?void 0:e.name)?t:"Unknown")},onPointerOver:()=>v(!0),onPointerOut:()=>v(!1),children:(0,r.jsx)("meshStandardMaterial",{color:s?"rgb(27, 194, 63)":g?"rgb(29, 88, 175)":"rgb(37, 158, 206)",side:d.$EB})},t)),f.map((e,t)=>(0,r.jsx)("lineSegments",{geometry:e,children:(0,r.jsx)("lineBasicMaterial",{color:"white"})},"border-".concat(t))),(g||s)&&(0,r.jsx)(l.E,{center:!0,position:[h.x,h.y,h.z],style:{font:"12px/1.2 system-ui",color:"#fff",background:"rgba(0,0,0,0.6)",padding:"2px 6px",borderRadius:"4px",pointerEvents:"none",whiteSpace:"nowrap"},children:null!=(n=null==(t=o.properties)?void 0:t.name)?n:"Unnamed"})]})}function k(e){let{height:t=60,radius:n=50,topColor:a="#ff4040",bottomColor:l="#ff9c3d",opacity:s=.85,glow:u=!1,glowColor:c="#2f7cff",glowScale:m=1.6,glowStrength:p=1,onClick:f,onPointerOver:h,onPointerOut:g}=e,v=i.useRef(null),x=i.useMemo(()=>new d.Ho_(n,n,t,32,1,!0),[n,t]),y=i.useMemo(()=>new d.BKk({transparent:!0,depthWrite:!1,blending:d.EZo,uniforms:{uTopColor:{value:new d.Q1f(a)},uBottomColor:{value:new d.Q1f(l)},uOpacity:{value:s},uTime:{value:0}},vertexShader:"\n      varying vec2 vUv;\n      void main() {\n        vUv = uv;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n      }\n    ",fragmentShader:"\n      varying vec2 vUv;\n      uniform vec3 uTopColor;\n      uniform vec3 uBottomColor;\n      uniform float uOpacity;\n      uniform float uTime;\n      void main() {\n        float grad = clamp(vUv.y, 0.0, 1.0);\n        float pulse = 0.5 + 0.5 * sin(uTime + vUv.y * 6.2831);\n        grad = clamp(grad * (0.75 + 0.25 * pulse), 0.0, 1.0);\n        vec3 col = mix(uBottomColor, uTopColor, grad);\n        float alpha = uOpacity * grad;\n        gl_FragColor = vec4(col, alpha);\n      }\n    "}),[a,l,s]),b=i.useMemo(()=>new d.Ho_(n,n,t+2,32,1,!0),[n,t,m]),j=i.useMemo(()=>new d.BKk({transparent:!0,depthWrite:!1,blending:d.EZo,uniforms:{uGlowColor:{value:new d.Q1f(c)},uTime:{value:0},uStrength:{value:p}},vertexShader:"\n      varying vec3 vNormal;\n      varying vec3 vViewDir;\n      void main(){\n        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n        vNormal = normalize(normalMatrix * normal);\n        vViewDir = normalize(-mvPosition.xyz);\n        gl_Position = projectionMatrix * mvPosition;\n      }\n    ",fragmentShader:"\n      precision mediump float;\n      varying vec3 vNormal;\n      varying vec3 vViewDir;\n      uniform vec3 uGlowColor;\n      uniform float uTime;\n      uniform float uStrength;\n      void main() {\n        float fres = pow(1.0 - max(dot(normalize(vNormal), normalize(vViewDir)), 0.0), 2.0);\n        float pulse = 0.6 + 0.4 * sin(uTime * 2.0);\n        float alpha = fres * pulse * uStrength;\n        gl_FragColor = vec4(uGlowColor, alpha);\n      }\n    "}),[c,p]);return(0,o.D)((e,t)=>{v.current&&(v.current.uniforms.uTime.value+=2*t),j.uniforms.uTime.value+=t}),(0,r.jsxs)("group",{children:[(0,r.jsx)("mesh",{rotation:[Math.PI/2,0,0],position:[0,0,t/2],geometry:x,material:y,onClick:f,onPointerOver:h,onPointerOut:g,ref:e=>{e&&(v.current=e.material)}}),u&&(0,r.jsx)("mesh",{rotation:[Math.PI/2,0,0],position:[0,0,(t+2)/2],geometry:b,material:j})]})}function P(e){let{name:t,lngLat:n,onSelectName:o,onClearSelection:a,isSelected:s,radius:u=3}=e,[c,d]=(0,i.useState)(!1),[m,p]=(0,i.useMemo)(()=>{var e;return null!=(e=S(n))?e:[0,0]},[n]),f=(0,i.useMemo)(()=>["CMA","HKSTP","BOCDSS","BOCYH"].includes(t),[t]),h="Hong Kong"===t||"Macau"===t?80:20,g=u&&u>0?"Hong Kong"!==t&&"Macau"!==t?.02:u:f?1:1.2;return(0,r.jsxs)("group",{position:[m,-p,5],children:[(0,r.jsx)(k,{height:h,radius:g*(c?1.3:1),topColor:c?"#2291ff":s?"rgb(250, 148, 53)":"rgb(255, 0, 0)",bottomColor:c?"#66c2ff":"#ffcf99",opacity:100,glow:!0,glowColor:"#2f7cff",glowScale:c?1.6:1.4,glowStrength:c?1.2:.8,onClick:e=>{e.stopPropagation(),null==o||o(t)},onPointerOver:e=>{e.stopPropagation(),d(!0)},onPointerOut:e=>{e.stopPropagation(),d(!1)}}),(c||s)&&(0,r.jsx)(l.E,{center:!0,position:[0,0,2],style:{font:"12px/1.2 system-ui",color:"#fff",background:"rgba(0,0,0,0.6)",padding:"2px 6px",borderRadius:"4px",pointerEvents:"none",whiteSpace:"nowrap"},children:t})]})}function N(e){let{onSelectName:t,onClearSelection:n,selectedName:o}=e,[a,l]=(0,i.useState)(3),s=(0,i.useMemo)(()=>[{name:"Hong Kong",lngLat:[114.1694,22.3193]},{name:"Macau",lngLat:[113.5439,22.1987]}],[o]);return(0,r.jsx)("group",{children:s.map(e=>(0,r.jsx)(P,{name:e.name,lngLat:e.lngLat,onSelectName:t,onClearSelection:n,isSelected:o===e.name,radius:"Hong Kong"===e.name||"Macau"===e.name?1.2:1},e.name))})}function E(e){let{device:t,selectedIMEI:n,onSelectIMEI:o,radius:a=3,onSelectName:s}=e,[u,c]=(0,i.useState)(!1),d=t.Location||String(t.DeviceID),m=a&&a>0?"Hong Kong"!==d&&"Macau"!==d?.02:a:1,p=n===String(t.DeviceID),f=(0,i.useMemo)(()=>{var e,n;let r=Number(null==(e=t.Coordinate)?void 0:e[0]),i=Number(null==(n=t.Coordinate)?void 0:n[1]);if(!Number.isFinite(r)||!Number.isFinite(i))return[0,0,0];let[o,a]=S([i,r]);return[o,-a,5]},[t.Coordinate]);return(0,r.jsxs)("group",{position:f,children:[(0,r.jsx)(k,{height:"Hong Kong"===d||"Macau"===d?80:20,radius:m*(u?1.3:1),topColor:u?"#2291ff":p?"rgb(250, 148, 53)":"rgb(255, 0, 0)",bottomColor:u?"#66c2ff":"#ffcf99",opacity:100,glow:!0,glowColor:"#2f7cff",glowScale:u?1.6:1.4,glowStrength:u?1.2:.8,onClick:e=>{e.stopPropagation(),o(String(t.DeviceID)),s(t.Location)},onPointerOver:e=>{e.stopPropagation(),c(!0)},onPointerOut:e=>{e.stopPropagation(),c(!1)}}),(u||p)&&(0,r.jsx)(l.E,{center:!0,position:[0,0,2],style:{font:"12px/1.2 system-ui",color:"#fff",background:"rgba(0,0,0,0.6)",padding:"2px 6px",borderRadius:"4px",pointerEvents:"none",whiteSpace:"nowrap"},children:d})]})}function T(e){let{devices:t,selectedIMEI:n,onSelectIMEI:i,onSelectName:o}=e;return t&&0!==t.length?(0,r.jsx)("group",{children:t.map(e=>(0,r.jsx)(E,{device:e,selectedIMEI:n,onSelectIMEI:i,onSelectName:o},String(e.DeviceID)))}):null}function D(e){let{geojson:t,controlsRef:n,onSelectName:a,selectedName:l,region:s,devices:u,onSelectIMEI:c,showMarkers:m=!1,showPillars:h=!1,onFilteredDevices:g}=e,v=(0,i.useRef)(null),{camera:x}=(0,o.C)(),[y,b]=(0,i.useState)(0),S=(0,i.useMemo)(()=>d.cj9.clamp(1.5+y/800,1.5,6),[y]);(0,i.useEffect)(()=>{if(!v.current||!(null==n?void 0:n.current))return;let e=requestAnimationFrame(()=>{let e=v.current,t=new d.NRn().setFromObject(e),r=new d.iyt;t.getBoundingSphere(r);let i=r.center.clone();e.position.set(e.position.x-i.x,e.position.y-i.y,e.position.z);let o=new d.NRn().setFromObject(e),a=new d.iyt;o.getBoundingSphere(a);let l=a.center;b(a.radius),n.current.target.copy(l),n.current.update(),x.position.set(l.x,l.y+.6*a.radius,l.z+2.2*a.radius),x.near=Math.max(.1,a.radius/100),x.far=Math.max(1e3,100*a.radius),x.updateProjectionMatrix()});return()=>cancelAnimationFrame(e)},[t,n,x]);let M=(0,i.useMemo)(()=>{if(!t)return null;let e=(t.features||[]).filter(e=>{var t;let n=String((null==e||null==(t=e.properties)?void 0:t.name)||"").toLowerCase();return"Hong Kong"===s?n.includes("hong kong")||n.includes("hksar")||n.includes("hk"):"Macau"!==s||n.includes("macau")||n.includes("macao")});return{type:"FeatureCollection",features:e.length>0?e:t.features||[]}},[t,s]),k=(0,i.useMemo)(()=>{if(!u||!M)return[];try{return u.filter(e=>{var t,n;let r=Number(null==(t=e.Coordinate)?void 0:t[0]),i=Number(null==(n=e.Coordinate)?void 0:n[1]);if(!Number.isFinite(r)||!Number.isFinite(i))return!1;let o=(0,w.zx)([i,r]),a=M.features||[];for(let e=0;e<a.length;e++)try{if((0,j.A)(o,a[e]))return!0}catch(e){}return!1})}catch(e){try{return u.filter(e=>{var t,n;let r=Number(null==(t=e.Coordinate)?void 0:t[0]),i=Number(null==(n=e.Coordinate)?void 0:n[1]);return Number.isFinite(r)&&Number.isFinite(i)&&p.A(M,[i,r])})}catch(e){try{let[[e,t],[n,r]]=f.A(M);return u.filter(i=>{var o,a;let l=Number(null==(o=i.Coordinate)?void 0:o[0]),s=Number(null==(a=i.Coordinate)?void 0:a[1]);return Number.isFinite(l)&&Number.isFinite(s)&&s>=e&&s<=n&&l>=t&&l<=r})}catch(e){return console.warn("Region filter failed; hiding pillars",e),[]}}}},[u,M]);return(0,i.useEffect)(()=>{null==g||g(k)},[k,g]),(0,r.jsxs)("group",{ref:v,scale:"Hong Kong"===s||"Macau"===s?[6,6,1]:[1,1,1],children:[t.features.map((e,t)=>(0,r.jsx)(C,{feature:e,onClick:void 0,onSelectName:a,isSelected:l===e.properties.name,hoverScaleZ:S},t)),m&&(0,r.jsx)(N,{onSelectName:a,selectedName:l}),h&&k&&c&&(0,r.jsx)(T,{devices:k,selectedIMEI:void 0,onSelectIMEI:c,onSelectName:a})]})}function z(e){var t,n,o,c,m;let{onMeshSelected:p}=e,f=(0,h.As)(),[v,x]=(0,i.useState)(null),j=(0,i.useRef)(null),[w,S]=(0,i.useState)(null),[M,C]=(0,i.useState)("China.json"),[k,P]=(0,i.useState)("China"),[N,E]=(0,i.useState)("map"),[T,z]=(0,i.useState)(null),[R,A]=(0,i.useState)([]),[B,F]=(0,i.useState)(!1),[_,H]=(0,i.useState)(!0),[W,K]=(0,i.useState)([]),[Y,q]=(0,i.useState)(""),[X,U]=(0,i.useState)({}),[V,Q]=(0,i.useState)([]),J=(0,i.useRef)(null),Z=(0,i.useRef)({}),G=(0,i.useCallback)(async()=>{var e;try{let e=null==f?void 0:f.signinSilent;if("function"==typeof e){let t=await e(),n=null==t?void 0:t.id_token;if(n)return n}}catch(e){}return(null==f||null==(e=f.user)?void 0:e.id_token)||""},[null==f||null==(t=f.user)?void 0:t.id_token]),[$,ee]=(0,i.useState)({}),[et,en]=(0,i.useState)([]),[er,ei]=(0,i.useState)([]),[eo,ea]=(0,i.useState)(!1),[el,es]=(0,i.useState)(""),[eu,ec]=(0,i.useState)(1e4),[ed,em]=(0,i.useState)(10),[ep,ef]=(0,i.useState)([]),eh=(0,i.useMemo)(()=>{let e=new Set(["Timestamp","DeviceID","DeviceType"]),t=er&&er.length>0?er:X&&"object"==typeof X?Object.keys(X):[],n=new Set;return t.forEach(t=>{let r=null==X?void 0:X[t];r&&"object"==typeof r&&Object.keys(r).forEach(t=>{e.has(t)||"number"!=typeof r[t]||n.add(t)})}),Array.from(n)},[X,er]);(0,i.useEffect)(()=>{let e=e=>{("Shift"===e.key||"Control"===e.key||"Meta"===e.key)&&ea(!0)},t=e=>{("Shift"===e.key||"Control"===e.key||"Meta"===e.key)&&ea(!1)},n=()=>ea(!1);return window.addEventListener("keydown",e),window.addEventListener("keyup",t),window.addEventListener("blur",n),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",t),window.removeEventListener("blur",n)}},[]),(0,i.useEffect)(()=>{ef(e=>{let t=new Set(eh),n=e.length>0,r=e.filter(e=>t.has(e));return n?0===r.length||r.length===e.length?e:r:eh})},[eh]),(0,i.useEffect)(()=>{if(!X||"object"!=typeof X)return;let e=Z.current,t=new Set(["Timestamp","DeviceID","DeviceType"]);Object.keys(X).forEach(n=>{let r=X[n];if(!r||"object"!=typeof r)return;let i=r.Timestamp,o="string"==typeof i?i:String(null!=i?i:"");o.includes("T")&&(o=o.split(".")[0].replace("T"," "));let a=e[n]||{timestamps:[],seriesMap:{}},l=[...a.timestamps,o],s=l.length>ed?l.slice(l.length-ed):l,u={...a.seriesMap};Object.keys(r).forEach(e=>{if(t.has(e))return;let n=r[e];if("number"!=typeof n||!Number.isFinite(n))return;let i=u[e]?[...u[e]]:[];i.push(Number(n)),u[e]=i.length>ed?i.slice(i.length-ed):i}),e[n]={timestamps:s,seriesMap:u}})},[X,ed]),(0,i.useEffect)(()=>{null==w?(P("China"),E("map"),H(!0)):"Hong Kong"===w?(P("Hong Kong"),E("region"),H(!0)):"Macau"===w?(P("Macau"),E("region"),H(!0)):"BOCYH"===w||"BOCDSS"===w?(P("Macau"),E("detail"),F(!1),H(!0)):E("map")},[w]),(0,i.useEffect)(()=>{let e="Hong Kong"===k?"HongKong.json":"Macau"===k?"Macau.json":"China.json";M!==e&&C(e)},[k,M]),(0,i.useEffect)(()=>{let e=!1;return fetch("/3dmodel/".concat(M)).then(e=>{if(!e.ok)throw Error("Failed to load ".concat(M));return e.json()}).then(t=>{e||x(t)}).catch(t=>{console.error("GeoJSON load error:",t),e||"China.json"===M||fetch("/3dmodel/China.json").then(e=>e.json()).then(x).catch(e=>console.error("Fallback load error:",e))}),()=>{e=!0}},[M]),(0,i.useEffect)(()=>{var e,t,n,r;f.isAuthenticated&&(null==(e=f.user)?void 0:e.id_token)&&(null==(n=f.user)||null==(t=n.profile)?void 0:t.email)&&(0,b.bC)(f.user.profile.email,null==(r=f.user)?void 0:r.id_token,G).then(e=>{var t,n;let r=Array.isArray(e.items)?e.items:[],i=Array.isArray(e.dev_access)?e.dev_access:[];K(r);let o=String((null==r||null==(t=r[0])?void 0:t.DeviceID)||"");q(o);let a={};for(let e=0;e<r.length;e++){let t=String(null==(n=r[e])?void 0:n.DeviceID),o=Array.isArray(null==i?void 0:i[e])?i[e].map(String):[];a[t]=o}ee(a),en(a[o]||[])}).catch(e=>console.error("3D getIMEIList error:",e))},[f.isAuthenticated,null==(n=f.user)?void 0:n.id_token,null==(c=f.user)||null==(o=c.profile)?void 0:o.email,G]),(0,i.useEffect)(()=>{var e;if(!Y||!(null==f||null==(e=f.user)?void 0:e.id_token))return;if(J.current){try{J.current.stop()}catch(e){}J.current=null}let t=(0,b.W4)({IMEI:Y,idToken:f.user.id_token,getIdToken:G,intervalMs:eu,callback:e=>{U(e.deviceMap)}});return J.current=t,t.start(),()=>{if(J.current){try{J.current.stop()}catch(e){}J.current=null}}},[Y,null==(m=f.user)?void 0:m.id_token,eu]),(0,i.useEffect)(()=>{null==p||p(T||null)},[T,p]),(0,i.useEffect)(()=>{en($[String(Y)]||[])},[Y,$]);let eg=(0,i.useMemo)(()=>{let e=X&&"object"==typeof X?Object.keys(X):[],t=Array.isArray(et)?et:[];return(null==t?void 0:t.length)?e.filter(e=>t.includes(e)):e},[X,et]),ev=(0,i.useCallback)(e=>{if(!e||!eg||0===eg.length)return!1;let t=e=>e.toLowerCase().replace(/[^a-z0-9]/g,""),n=t(e);return!!eg.includes(e)||!!eg.find(e=>{let r=t(e);return r.includes(n)||n.includes(r)})},[eg]),ex=(0,i.useCallback)(e=>{if(!e)return void z(null);if(!ev(e))return;z(e),A(t=>eo?t.includes(e)?t.filter(t=>t!==e):[...t,e]:[e]);let t=e=>e.toLowerCase().replace(/[^a-z0-9]/g,""),n=t(e),r=(eg.includes(e)?e:eg.find(e=>{let r=t(e);return r.includes(n)||n.includes(r)})||null)||eg[0];es(r),ei(e=>{if(eo){let t=new Set(e);return t.has(r)?t.delete(r):t.add(r),Array.from(t)}return[r]})},[eg,ev,eo]);return((0,i.useEffect)(()=>{if(!eg||0===eg.length){es(""),ei([]);return}ei(e=>{let t=new Set(eg),n=e.filter(e=>t.has(e)),r=n.length>0?n:eg;return e.length===r.length&&e.every(e=>r.includes(e))?e:r}),el&&eg.includes(el)||(T&&eg.includes(T)?es(T):es(eg[0]))},[eg,T]),v)?(0,r.jsxs)("div",{style:{display:"flex",width:"100%",height:"100vh"},children:[(0,r.jsxs)("div",{style:{flex:"1 1 auto",position:"relative",width:"70%"},children:[(0,r.jsx)("div",{style:{position:"absolute",top:16,left:16,zIndex:1,padding:"8px 12px",borderRadius:8},children:(0,r.jsx)("button",{className:"brand-button",onClick:()=>{P("China"),E("map")},children:"Back to main map"})}),(0,r.jsx)("div",{style:{position:"absolute",top:70,left:16,zIndex:1,padding:"8px 12px",borderRadius:8,backgroundColor:"rgba(0, 0, 0, 0)"},children:(0,r.jsx)("a",{href:"/login",children:(0,r.jsx)("img",{src:"2d.png",alt:"Latest",style:{height:"36px"}})})}),(0,r.jsxs)(a.Hl,{camera:{position:[33.4,-202.9,447.9],fov:45},onCreated:e=>{let{gl:t}=e;t.outputColorSpace=d.er$,t.toneMapping=d.FV,t.toneMappingExposure=1},children:[(0,r.jsx)(L,{mode:N,currentRegion:k}),(0,r.jsx)(s.OH,{preset:"city",background:!1}),(0,r.jsx)("ambientLight",{intensity:.5}),(0,r.jsx)("directionalLight",{position:[100,100,200],intensity:.8}),"detail"!==N&&(0,r.jsx)(D,{geojson:v,controlsRef:j,onSelectName:S,selectedName:w,region:k,devices:W,onSelectIMEI:q,showPillars:"region"===N,showMarkers:"map"===N,onFilteredDevices:Q}),"detail"===N&&"BOCYH"===w&&(0,r.jsx)(i.Suspense,{fallback:(0,r.jsxs)(l.E,{center:!0,children:[(0,r.jsx)("div",{className:"r3d-loader"}),(0,r.jsx)("div",{style:{marginTop:8,color:"#fff"},children:"Loading model…"})]}),children:(0,r.jsx)(O,{glbName:"/3dmodel/1403.glb",controlsRef:j,onMeshSelected:ex,selectedMeshNames:R,isMeshAllowed:ev,onModelLoaded:()=>F(!0),showInlineChart:!_,chartDeviceMap:X,chartDeviceTypes:er,chartDataTypes:ep,chartMaxPoints:ed,chartHistoryRef:Z})}),"detail"===N&&"BOCDSS"===w&&(0,r.jsx)(i.Suspense,{fallback:(0,r.jsxs)(l.E,{center:!0,children:[(0,r.jsx)("div",{className:"r3d-loader"}),(0,r.jsx)("div",{style:{marginTop:8,color:"#fff"},children:"Loading model…"})]}),children:(0,r.jsx)(O,{glbName:"/3dmodel/CMA+.glb",controlsRef:j,onMeshSelected:ex,selectedMeshNames:R,isMeshAllowed:ev,onModelLoaded:()=>F(!0),showInlineChart:!_,chartDeviceMap:X,chartDeviceTypes:er,chartDataTypes:ep,chartMaxPoints:ed,chartHistoryRef:Z})}),(0,r.jsx)(I,{controlsRef:j,initial:{position:[33.4,-202.9,447.9],radius:494.5,alphaDeg:1,betaDeg:116.2}}),(0,r.jsx)(u.N,{ref:j,enableDamping:!0,dampingFactor:.08})]})]}),"detail"===N&&B&&_&&(0,r.jsxs)("div",{style:{flex:"0 0 400px",width:400,minWidth:320,flexShrink:0,background:"rgba(1, 7, 22, 0.9)",color:"#fff",padding:12,overflowY:"auto"},children:[(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[(0,r.jsx)("div",{style:{fontWeight:700},children:"Detail Metrics"}),(0,r.jsx)("button",{onClick:()=>H(!1),title:"Hide panel",style:{background:"rgba(255,255,255,0.1)",color:"#fff",border:"1px solid rgba(255,255,255,0.2)",borderRadius:4,padding:"4px 8px",cursor:"pointer"},children:"→"})]}),Y?R.length>0?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{style:{marginBottom:12},children:[(0,r.jsxs)("div",{className:"control-row",style:{marginBottom:8},children:[(0,r.jsx)("label",{style:{marginRight:8},children:"Realtime Devices:"}),(0,r.jsx)("select",{multiple:!0,value:er,onChange:e=>{let t=Array.from(e.target.selectedOptions).map(e=>e.value);ei(t);let n=t[t.length-1];n&&es(n)},size:Math.min(6,Math.max(2,eg.length)),style:{background:"rgba(255, 255, 255, 0.9)",color:"rgba(0, 0, 0, 0.9)",minWidth:220},children:eg.map(e=>(0,r.jsx)("option",{value:e,children:e},e))}),(0,r.jsx)("div",{style:{marginTop:6,fontSize:12,opacity:.75},children:"Tip: Use Ctrl/Shift to multi-select. Click meshes to toggle."})]}),(0,r.jsxs)("div",{className:"control-row",style:{marginBottom:8},children:[(0,r.jsx)("label",{style:{marginRight:8,display:"block"},children:"Data Types:"}),(0,r.jsx)("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6},children:eh.map(e=>{let t=ep.includes(e);return(0,r.jsxs)("label",{style:{display:"flex",alignItems:"center",gap:6,background:"rgba(255,255,255,0.9)",color:"rgba(0,0,0,0.9)",padding:"6px 8px",borderRadius:6},children:[(0,r.jsx)("input",{type:"checkbox",checked:t,onChange:t=>{ef(n=>{let r=new Set(n);return t.target.checked?r.add(e):r.delete(e),Array.from(r)})}}),e]},e)})})]}),(0,r.jsxs)("div",{className:"control-row",style:{marginBottom:8},children:[(0,r.jsx)("label",{style:{marginRight:8},children:"Update Interval:"}),(0,r.jsxs)("select",{value:String(eu),onChange:e=>ec(Number(e.target.value)),style:{background:"rgba(255, 255, 255, 0.9)",color:"rgba(0, 0, 0, 0.9)"},children:[(0,r.jsx)("option",{value:1e4,children:"10s"}),(0,r.jsx)("option",{value:3e4,children:"30s"}),(0,r.jsx)("option",{value:6e4,children:"1 min"}),(0,r.jsx)("option",{value:3e5,children:"5 min"})]})]}),(0,r.jsxs)("div",{className:"control-row",children:[(0,r.jsx)("label",{style:{marginRight:8},children:"Max Points:"}),(0,r.jsx)("input",{type:"number",min:5,max:500,step:5,value:ed,onChange:e=>em(Math.max(1,Number(e.target.value)||10)),style:{background:"rgba(255, 255, 255, 0.9)",color:"rgba(0, 0, 0, 0.9)"}})]})]}),er&&er.length>0?er.map(e=>(0,r.jsxs)(i.Fragment,{children:[(0,r.jsx)(g.S,{deviceMap:X,device:[e],dataType:ep,compact:!0}),(0,r.jsx)(y,{deviceMap:X,deviceType:e,dataType:ep,maxPoints:ed,title:"Realtime Line Chart",height:180,historyRef:Z})]},e)):(0,r.jsx)("div",{children:"Select one or more device types to view metrics"})]}):(0,r.jsx)("div",{children:"Click a model mesh to show gauges and chart"}):(0,r.jsx)("div",{children:"No IMEI available for this user"})]}),"detail"===N&&B&&!_&&(0,r.jsx)("button",{onClick:()=>H(!0),title:"Show panel",style:{position:"fixed",right:0,top:"50%",transform:"translateY(-50%)",zIndex:1e3,background:"rgba(1, 7, 22, 0.9)",color:"#fff",border:"1px solid rgba(255,255,255,0.2)",borderRight:"none",borderRadius:"6px 0 0 6px",padding:"10px 12px",cursor:"pointer"},children:"←"})]}):(0,r.jsx)("div",{children:"Loading…"})}function I(e){let{controlsRef:t,initial:n}=e,{camera:r,size:a}=(0,o.C)(),l=(0,i.useRef)(!1);return(0,i.useEffect)(()=>{if(l.current)return;let e=requestAnimationFrame(()=>{if(!(null==t?void 0:t.current))return;let{position:e,radius:i,alphaDeg:o,betaDeg:a}=n,s=d.cj9.degToRad(o),u=d.cj9.degToRad(a),c=Math.sin(u),m=Math.cos(u),p=Math.sin(s),f=Math.cos(s),h=new d.Pq0(e[0]-i*c*p,e[1]-i*m,e[2]-i*c*f);r.position.set(e[0],e[1],e[2]),t.current.target.copy(h),t.current.update(),l.current=!0});return()=>cancelAnimationFrame(e)},[t,r,n]),null}function O(e){let{glbName:t,controlsRef:n,onMeshSelected:a,selectedMeshNames:s=[],isMeshAllowed:u,onModelLoaded:m,showInlineChart:p=!1,chartDeviceMap:f,chartDeviceTypes:h,chartDataTypes:v=[],chartMaxPoints:x=10,chartHistoryRef:b}=e,{camera:j,size:w}=(0,o.C)(),S=(0,c.p)(t),M=(0,i.useRef)(null),[C,k]=(0,i.useState)([]),P=(0,i.useRef)({}),[N,E]=(0,i.useState)(0),T=(0,i.useRef)(null);return(0,i.useEffect)(()=>{var e,t;if(!(null==S?void 0:S.scene))return;let r=new d.NRn().setFromObject(S.scene),i=new d.iyt;r.getBoundingSphere(i);let o=i.center;null==(e=n.current)||e.target.copy(o),null==(t=n.current)||t.update(),j.position.set(o.x,o.y+.6*i.radius,o.z+2.2*i.radius),j.near=Math.max(.1,i.radius/100),j.far=Math.max(1e3,100*i.radius),j.updateProjectionMatrix(),null==m||m()},[S,n,j]),(0,i.useEffect)(()=>{let e=[];if(!(null==S?void 0:S.scene))return void k([]);s.forEach(t=>{var n,r;let i=null==(n=(r=S.scene).getObjectByName)?void 0:n.call(r,t);if(!i)return;let o=new d.NRn().setFromObject(i),a=new d.iyt;o.getBoundingSphere(a);let l=a.center.clone().clone();M.current&&M.current.worldToLocal(l),e.push({name:t,center:[l.x,l.y,l.z],radius:a.radius})}),k(e)},[s,S]),(0,r.jsxs)("group",{ref:M,children:[(null==S?void 0:S.scene)&&(0,r.jsx)("primitive",{object:S.scene,onPointerDown:e=>{e.stopPropagation();let t=e.object,n=(null==t?void 0:t.name)||"Unnamed";(!u||u(n))&&(null==a||a(n))}}),C.map(e=>(0,r.jsx)(B,{center:e.center,radius:e.radius},e.name)),C.length>0&&p&&f&&h&&h.length>0&&(()=>{let e=[],t=e=>{let t=e.clone().project(j);return[(.5*t.x+.5)*w.width,(-(.5*t.y)+.5)*w.height]},n=(e,n,r)=>{let i=new d.Pq0;j.getWorldDirection(i);let o=j.up.clone().normalize(),a=new d.Pq0().crossVectors(i,o).normalize(),l=t(e),s=t(e.clone().add(a.clone().multiplyScalar(1))),u=t(e.clone().add(o.clone().multiplyScalar(1))),c=Math.max(.001,Math.abs(s[0]-l[0])),m=Math.max(.001,Math.abs(u[1]-l[1]));return e.clone().add(a.multiplyScalar(n/c)).add(o.multiplyScalar(r/m))},o=t=>{for(let n of e)if(!(t.maxX<n.box.minX||t.minX>n.box.maxX||t.maxY<n.box.minY||t.minY>n.box.maxY))return!0;return!1},a=e=>e.toLowerCase().replace(/[^a-z0-9]/g,"");return C.forEach(r=>{let i=a(r.name),l=h.find(e=>{let t=a(e);return t.includes(i)||i.includes(t)})||h[0],s=new d.Pq0(r.center[0],r.center[1]+.9*r.radius,r.center[2]),u=0,c=0,m=s,p=P.current[l];if(p){let[n,r]=t(new d.Pq0(p[0],p[1],p[2]));e.push({box:{minX:n-100,minY:r-70,maxX:n+100,maxY:r+70},pos:[p[0],-p[1],p[2]],dt:l});return}for(let r=0;r<50;r++){let[i,a]=t(m=n(s,u,c)),d={minX:i-100,minY:a-70,maxX:i+100,maxY:a+70};if(!o(d)){e.push({box:d,pos:[m.x,m.y,m.z],dt:l});break}let p=r+1;u=(p%2==0?-1:1)*Math.ceil(p/2)*24,p%4==0&&(c+=18)}if(0===e.length){let[n,r]=t(m);e.push({box:{minX:n-100,minY:r-70,maxX:n+100,maxY:r+70},pos:[m.x,m.y,m.z],dt:l})}}),e.map((e,t)=>{let o=n(new d.Pq0(e.pos[0],e.pos[1],e.pos[2]),-114,-84);return(0,r.jsxs)(i.Fragment,{children:[(0,r.jsx)(l.E,{center:!0,position:e.pos,style:{pointerEvents:"none",userSelect:"none"},children:(0,r.jsx)("div",{style:{transform:"scale(0.6)",transformOrigin:"top center"},children:(0,r.jsxs)("div",{style:{width:450,maxWidth:450,background:"rgba(0,0,0,0.8)",color:"#fff",border:"1px solid rgba(255,255,255,0.25)",borderRadius:12,padding:6,boxShadow:"0 6px 16px rgba(0,0,0,0.4)",fontSize:14,lineHeight:1.35},children:[(0,r.jsx)("div",{style:{marginBottom:6},children:(0,r.jsx)(g.S,{deviceMap:f,device:[e.dt],dataType:v,compact:!0})}),(0,r.jsx)(y,{deviceMap:f,deviceType:e.dt,dataType:v,maxPoints:x,title:"Realtime Line Chart",height:120,historyRef:b})]})})}),(0,r.jsx)(l.E,{center:!0,position:[o.x,o.y,o.z],style:{pointerEvents:"auto"},children:(0,r.jsx)("div",{onPointerDown:t=>{if(t.stopPropagation(),0===t.button){try{var n,r;null==(n=(r=t.currentTarget).setPointerCapture)||n.call(r,t.pointerId)}catch(e){}T.current={key:e.dt,base:P.current[e.dt]||e.pos,startX:t.clientX,startY:t.clientY,pointerId:t.pointerId}}},onPointerMove:e=>{if(!T.current||1!==e.buttons||void 0!==T.current.pointerId&&e.pointerId!==T.current.pointerId)return;e.stopPropagation();let t=T.current,r=e.clientX-t.startX,i=e.clientY-t.startY,o=n(new d.Pq0(t.base[0],t.base[1],t.base[2]),r,i);P.current[t.key]=[o.x,o.y,o.z],E(e=>e+1)},onPointerUp:e=>{e.stopPropagation();try{var t,n;null==(t=(n=e.currentTarget).releasePointerCapture)||t.call(n,e.pointerId)}catch(e){}T.current=null},onPointerLeave:e=>{if(T.current){try{var t,n;null==(t=(n=e.currentTarget).releasePointerCapture)||t.call(n,e.pointerId)}catch(e){}T.current=null}},style:{width:16,height:16,borderRadius:8,background:"#66ccff",boxShadow:"0 0 8px rgba(102,204,255,0.8)",cursor:"grab"}})})]},"frag-".concat(t))})})()]})}function R(e){let{color:t="#0b2d5e"}=e,{scene:n}=(0,o.C)();return(0,i.useEffect)(()=>{let e=n.background;return n.background=new d.Q1f(t),()=>{n.background=e}},[n,t]),null}function A(e){let t,{options:n}=e,{camera:a}=(0,o.C)(),l=(0,i.useRef)(null),s=(0,i.useMemo)(()=>{let e=new d.LoY,t=Math.max(2,n.pointLayout.row),r=Math.max(2,n.pointLayout.col),i=n.gridSize,o=new Float32Array(t*r*3),a=-i/2,l=-i/2,s=i/(r-1),u=i/(t-1),c=0;for(let e=0;e<t;e++)for(let t=0;t<r;t++){let n=a+t*s,r=l+e*u;o[c++]=n,o[c++]=.2,o[c++]=r}return e.setAttribute("position",new d.THS(o,3)),e},[n.pointLayout.row,n.pointLayout.col,n.gridSize]),u=(0,i.useMemo)(()=>{var e,t;return new d.BKk({transparent:!0,depthWrite:!1,blending:null!=(e=n.pointBlending)?e:d.EZo,uniforms:{uTime:{value:0},uBaseColor:{value:new d.Q1f(n.pointColor)},uDiffuseColor:{value:new d.Q1f(n.diffuseColor)},uSize:{value:n.pointSize},uWidth:{value:n.diffuseWidth},uSpeed:{value:n.diffuseSpeed},uEnable:{value:+!!n.diffuse},uDir:{value:null!=(t=n.diffuseDir)?t:0}},vertexShader:"\n        uniform float uSize;\n        varying vec2 vPos;\n        void main() {\n          vPos = position.xz;\n          gl_PointSize = uSize;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:"\n        precision mediump float;\n        varying vec2 vPos;\n        uniform vec3 uBaseColor;\n        uniform vec3 uDiffuseColor;\n        uniform float uTime;\n        uniform float uWidth;\n        uniform float uSpeed;\n        uniform float uEnable;\n        uniform float uDir;\n        void main() {\n          vec2 p = gl_PointCoord.xy * 2.0 - 1.0;\n          float m = 1.0 - smoothstep(0.95, 1.0, length(p));\n          float alpha = 0.8 * m;\n          vec3 col = uBaseColor;\n\n          if (uEnable > 0.5) {\n            float r = mod(uTime * uSpeed, 2000.0);\n            float d;\n            if (uDir < 0.5) {\n              d = length(vPos);\n            } else if (uDir < 1.5) {\n              d = abs(vPos.x);\n            } else {\n              d = abs(vPos.y);\n            }\n            float glow = smoothstep(r - uWidth, r, d) * (1.0 - smoothstep(r, r + uWidth, d));\n            col = mix(col, uDiffuseColor, glow);\n            alpha = mix(alpha, 1.0 * m, glow);\n          }\n\n          gl_FragColor = vec4(col, alpha);\n        }\n      "})},[n.pointBlending,n.pointColor,n.diffuseColor,n.pointSize,n.diffuseWidth,n.diffuseSpeed,n.diffuse,n.diffuseDir]);(0,o.D)((e,t)=>{if(u.uniforms.uTime.value+=60*t,n.adaptivePointSize&&l.current){var r,i;let e=new d.Pq0;l.current.getWorldPosition(e);let t=a.position.distanceTo(e),o=null!=(r=n.minPointSize)?r:1.5,s=null!=(i=n.maxPointSize)?i:5,c=n.pointSize,m=d.cj9.clamp(800/(t+1)*c,o,s);u.uniforms.uSize.value=m}});let c=(0,i.useMemo)(()=>new d.Q1f(n.gridColor),[n.gridColor]);return(0,r.jsxs)("group",{ref:l,position:Array.isArray(t=n.position)?t:[t.x,t.y,t.z],rotation:[Math.PI/2,0,0],renderOrder:-1,children:[(0,r.jsx)("gridHelper",{args:[n.gridSize,n.gridDivision,c,c]}),(0,r.jsx)("points",{geometry:s,material:u})]})}function L(e){let{mode:t,currentRegion:n}=e,i="detail"===t;return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(R,{color:i?"rgb(197, 197, 197)":"rgb(1, 7, 22)"}),!i&&(0,r.jsx)(A,{options:{position:new d.Pq0(0,0,-1),gridSize:"Hong Kong"===n||"Macau"===n?160:12e3,gridDivision:"Hong Kong"===n||"Macau"===n?32:400,gridColor:2046827,shapeSize:0,shapeColor:3104681,pointSize:2,pointColor:4891647,pointLayout:"Hong Kong"===n||"Macau"===n?{row:128,col:128}:{row:1600,col:1600},pointBlending:d.EZo,diffuse:!0,diffuseSpeed:10,diffuseColor:65535,diffuseWidth:30,diffuseDir:0,adaptivePointSize:!0,minPointSize:"Hong Kong"===n||"Macau"===n?.1:1.5,maxPointSize:5}})]})}function B(e){let{center:t,radius:n,color:a=new d.Q1f(4891647),strength:l=1}=e,s=(0,i.useMemo)(()=>{let e=new d.Q1f(a);return new d.BKk({transparent:!0,depthWrite:!1,blending:d.EZo,side:d.hsX,uniforms:{uTime:{value:0},uColor:{value:e},uStrength:{value:l}},vertexShader:"\n        varying vec3 vWorldPos;\n        varying vec3 vNormal;\n        void main() {\n          vNormal = normalize(normalMatrix * normal);\n          vec4 worldPos = modelMatrix * vec4(position, 1.0);\n          vWorldPos = worldPos.xyz;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:"\n        precision mediump float;\n        varying vec3 vWorldPos;\n        varying vec3 vNormal;\n        uniform vec3 uColor;\n        uniform float uStrength;\n        uniform float uTime;\n        void main() {\n          vec3 viewDir = normalize(cameraPosition - vWorldPos);\n          float fresnel = pow(1.0 - max(dot(normalize(vNormal), viewDir), 0.0), 3.0);\n          float pulse = 0.85 + 0.15 * sin(uTime * 2.0);\n          float alpha = fresnel * uStrength * pulse;\n          gl_FragColor = vec4(uColor * alpha, alpha);\n        }\n      "})},[a,l]);return(0,o.D)((e,t)=>{s.uniforms.uTime.value+=t}),(0,r.jsx)("mesh",{position:t,material:s,children:(0,r.jsx)("sphereGeometry",{args:[1.08*n,48,48]})})}let F=function(){return(0,i.useEffect)(()=>{let e=localStorage.getItem("theme-name"),t=localStorage.getItem("mode-name"),n=document.body.classList;return n.remove("theme-a","theme-b","theme-c","mode-light","mode-dark"),n.add(e||"theme-a"),n.add(t||"mode-light"),n.add("no-footer"),()=>{n.remove("no-footer")}},[]),(0,r.jsx)("div",{style:{position:"fixed",inset:0},children:(0,r.jsx)(z,{})})}}},e=>{e.O(0,[647,367,831,413,689,243,627,441,255,358],()=>e(e.s=1337)),_N_E=e.O()}]);